{% extends "base.html" %}
{% block title %}Dashboard - Guruji{% endblock %}

{% block content %}
<div class="dashboard">
    <div class="empty-state large" id="loading-state">
        <i class="fas fa-spinner fa-spin"></i>
        <p>Loading your dashboard...</p>
    </div>

    <div id="not-logged-in" style="display: none;">
        <div class="empty-state large">
            <i class="fas fa-lock"></i>
            <h3>Please sign in to access your dashboard</h3>
            <p>You need to be logged in to view this page</p>
            <button onclick="window.Clerk.openSignIn()" class="btn btn-primary btn-lg">
                <i class="fas fa-sign-in-alt"></i> Sign In
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Check cache first for faster decision-making
    (function () {
        const cachedUserId = window.AuthCache ? window.AuthCache.getUserId() : null;

        // If we have cached user ID, start API call early
        if (cachedUserId) {
            window._earlyDataPromise = fetch('/api/dashboard/student-data', {
                headers: { 'X-Clerk-User-Id': cachedUserId }
            }).then(res => res.ok ? res.json() : null).catch(() => null);
        }
    })();

    // Wait for Clerk to confirm auth state
    function initDashboard() {
        if (!window.Clerk) {
            setTimeout(initDashboard, 100);
            return;
        }

        window.Clerk.load().then(async () => {
            const loading = document.getElementById('loading-state');
            const notLoggedIn = document.getElementById('not-logged-in');

            if (!window.Clerk.user) {
                // Clear any stale cache
                if (window.AuthCache) window.AuthCache.clear();
                loading.style.display = 'none';
                notLoggedIn.style.display = 'block';
                return;
            }

            // Sync cache with actual user
            if (window.AuthCache) {
                window.AuthCache.syncWithClerk(window.Clerk.user);
            }

            // Use early data if available, otherwise fetch fresh
            try {
                let data = null;
                if (window._earlyDataPromise) {
                    data = await window._earlyDataPromise;
                }

                if (!data) {
                    const res = await fetch('/api/dashboard/student-data', {
                        headers: { 'X-Clerk-User-Id': window.Clerk.user.id }
                    });

                    if (res.ok) {
                        data = await res.json();
                    } else if (res.status === 404) {
                        window.location.href = '/select-role';
                        return;
                    } else {
                        window.location.href = '/select-role';
                        return;
                    }
                }

                // Redirect based on role and verification status
                if (data.user.role === 'instructor') {
                    if (data.user.verification_status === 'pending') {
                        window.location.href = '/verification-pending';
                    } else if (data.user.verification_status === 'approved') {
                        window.location.href = '/dashboard/instructor';
                    } else {
                        window.location.href = '/dashboard/student';
                    }
                } else {
                    window.location.href = '/dashboard/student';
                }
            } catch (err) {
                console.error(err);
                window.location.href = '/select-role';
            }
        });
    }

    initDashboard();
</script>
{% endblock %}