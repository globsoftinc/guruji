<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Guruji{% endblock %}</title>
    <meta name="description"
        content="{% block description %}Learn from the best with live Google Meet classes and recorded lectures{% endblock %}">

    <!-- Remix Icons (for social icons) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.2.0/remixicon.min.css">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@600;700;800&display=swap"
        rel="stylesheet">

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <!-- Favicons -->
    <link rel="apple-touch-icon" sizes="180x180"
        href="{{ url_for('static', filename='favicons/apple-touch-icon.png') }}">
    <link rel="icon" type="image/png" sizes="32x32"
        href="{{ url_for('static', filename='favicons/favicon-32x32.png') }}">
    <link rel="icon" type="image/png" sizes="16x16"
        href="{{ url_for('static', filename='favicons/favicon-16x16.png') }}">
    <link rel="manifest" href="{{ url_for('static', filename='favicons/site.webmanifest') }}">

    <!-- Browser Detection (for in-app browser auth handling) -->
    <script src="{{ url_for('static', filename='js/browser-detect.js') }}"></script>

    <!-- Auth Cache (loads before Clerk for optimistic UI) -->
    <script src="{{ url_for('static', filename='js/auth-cache.js') }}"></script>

    <!-- Clerk -->
    <script async crossorigin="anonymous" data-clerk-publishable-key="{{ config.CLERK_PUBLISHABLE_KEY }}"
        src="https://cdn.jsdelivr.net/npm/@clerk/clerk-js@latest/dist/clerk.browser.js" type="text/javascript"></script>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">

    {% block head %}{% endblock %}
</head>

<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="/" class="nav-logo">
                <span class="logo-icon"></span>
                <span class="logo-text">Guruji</span>
            </a>

            <div class="nav-menu">
                <a href="/courses" class="nav-link">Courses</a>
                <div id="user-button"></div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        {% block content %}{% endblock %}
    </main>

    <!-- Footer -->
    <footer class="footer" id="footer">
        <div class="footer__container container grid">
            <div>
                <img src="{{ url_for('static', filename='img/guruji.png') }}" height="20%" width="20%"
                    alt="Guruji Logo"> <br>
                <a href="/" class="footer__logo">
                    Guruji
                </a>

                <p class="footer__description">
                    Bharatpur 7 Chitwan<br> 44200, Madi Thori Road <br> Nepal <br>
                </p>
                <div style="padding-top:10px;">
                    <div class="footer__social">
                        <a href="https://www.facebook.com/globsoftinc" target="_blank" class="footer__social-link">
                            <i class="ri-facebook-circle-fill"></i>
                        </a>
                        <a href="https://www.instagram.com/globsoftinc" target="_blank" class="footer__social-link">
                            <i class="ri-instagram-fill"></i>
                        </a>
                        <a href="https://x.com/globsoftinc" target="_blank" class="footer__social-link">
                            <i class="ri-twitter-x-line"></i>
                        </a>
                        <a href="https://www.linkedin.com/company/globsoftinc" target="_blank"
                            class="footer__social-link">
                            <i class="ri-linkedin-fill"></i>
                        </a>
                        <a href="https://youtube.com/@globsoftinc" target="_blank" class="footer__social-link">
                            <i class="ri-youtube-fill"></i>
                        </a>
                    </div>
                </div>
            </div>

            <div class="footer__content grid">
                <div>
                    <h3 class="footer__title">COMPANY</h3>
                    <ul class="footer__links">
                        <li><a href="/" class="footer__link">Home</a></li>
                        <li><a href="https://globsoft.tech/#about" class="footer__link">About Us</a></li>
                        <li><a href="https://globsoft.tech/#contact" class="footer__link">Contact</a></li>
                        <li><a href="https://globsoft.tech/support.html" class="footer__link">Support</a></li>
                        <li><a href="https://globsoft.tech/products.html" class="footer__link">Products</a></li>
                    </ul>
                </div>
                <div>
                    <h3 class="footer__title">PRODUCTS</h3>
                    <ul class="footer__links">
                        <li><a href="https://globweb.globsoft.tech" class="footer__link">GlobWeb</a></li>
                        <li><a href="https://sanourl.globsoft.tech" class="footer__link">SanoURL</a></li>
                        <li><a href="https://anthanabbe.globsoft.tech" class="footer__link">Anthanabbe</a></li>
                        <li><a href="https://clearcut.globsoft.tech" class="footer__link">ClearCut</a></li>
                        <li><a href="https://globsoft.tech/products.html" class="footer__link">Others</a></li>
                    </ul>
                </div>
                <div>
                    <h3 class="footer__title">LEGAL</h3>
                    <ul class="footer__links">
                        <li><a href="https://globsoft.tech/privacy.html" target="_blank" class="footer__link">Privacy
                                Policy</a></li>
                        <li><a href="https://globsoft.tech/terms.html" target="_blank" class="footer__link">Terms of
                                Service</a></li>
                        <li><a href="https://globsoft.tech/terms.html" target="_blank" class="footer__link">Acceptable
                                Use</a></li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="footer__copy">
            <p>Â©
                <script>document.write(new Date().getFullYear())</script> Guruji. Powered by <a
                    href="https://globsoft.tech/" target="_blank">GlobSoft Inc.</a>
            </p>
        </div>
    </footer>

    <!-- Custom JS -->
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>

    <script>
            // Render optimistic UI immediately from cache (before Clerk loads)
            (function () {
                const userButtonDiv = document.getElementById("user-button");
                if (userButtonDiv && window.AuthCache) {
                    window.AuthCache.renderOptimisticUI(userButtonDiv);
                }
            })();

        // Initialize Clerk in background and sync when ready
        function initClerkAuth() {
            if (!window.Clerk) {
                // Clerk not loaded yet, retry
                setTimeout(initClerkAuth, 100);
                return;
            }

            window.Clerk.load().then(async () => {
                const userButtonDiv = document.getElementById("user-button");

                // Sync cache with actual Clerk state
                if (window.AuthCache) {
                    window.AuthCache.syncWithClerk(window.Clerk.user);
                }

                // Track if user was already signed in when page loaded
                const wasSignedIn = !!window.Clerk.user;

                // Listen for sign-in events (for pop-up auth redirect)
                window.Clerk.addListener((event) => {
                    // Only redirect if:
                    // 1. User is now signed in
                    // 2. User was NOT signed in when page loaded (fresh sign-in)
                    // 3. We're not already on dashboard or sign-in/sign-up pages
                    if (event.user && !wasSignedIn &&
                        !window.location.pathname.startsWith('/dashboard') &&
                        !window.location.pathname.startsWith('/sign-')) {
                        // Small delay to ensure session is fully established
                        setTimeout(() => {
                            window.location.href = '/dashboard';
                        }, 100);
                    }
                });

                if (window.Clerk.user) {
                    // Clear any optimistic UI and mount real Clerk user button
                    userButtonDiv.innerHTML = '';
                    window.Clerk.mountUserButton(userButtonDiv, {
                        afterSignOutUrl: "/",
                        signOutCallback: () => {
                            // Clear cache on sign out
                            if (window.AuthCache) {
                                window.AuthCache.clear();
                            }
                        }
                    });

                    // Add Dashboard link if not already present
                    if (!userButtonDiv.parentElement.querySelector('a[href="/dashboard"]')) {
                        const dashLink = document.createElement('a');
                        dashLink.href = '/dashboard';
                        dashLink.className = 'nav-link';
                        dashLink.textContent = 'Dashboard';
                        userButtonDiv.parentElement.insertBefore(dashLink, userButtonDiv);
                    }

                    // Auto-sync profile data to backend (non-blocking)
                    try {
                        const user = window.Clerk.user;
                        fetch('/api/auth/sync-profile', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                clerk_user_id: user.id,
                                email: user.primaryEmailAddress?.emailAddress || user.emailAddresses?.[0]?.emailAddress || '',
                                name: user.fullName || `${user.firstName || ''} ${user.lastName || ''}`.trim() || 'User',
                                profile_image: user.imageUrl || null
                            })
                        });
                    } catch (e) { console.log('Profile sync skipped'); }
                } else {
                    // Not logged in - show Sign In or Sign Up based on account status
                    userButtonDiv.innerHTML = '';
                    const signInBtn = document.createElement('button');
                    signInBtn.className = 'btn btn-primary';

                    const hasAccount = window.AuthCache && window.AuthCache.hasAccount();
                    signInBtn.innerHTML = hasAccount
                        ? '<i class="fas fa-sign-in-alt"></i> Sign In'
                        : '<i class="fas fa-user-plus"></i> Sign Up';

                    signInBtn.onclick = () => {
                        // Use BrowserDetect for in-app browser compatible auth
                        if (window.BrowserDetect) {
                            if (hasAccount) {
                                window.BrowserDetect.openSignIn();
                            } else {
                                window.BrowserDetect.openSignUp();
                            }
                        } else if (hasAccount) {
                            window.Clerk.openSignIn();
                        } else {
                            window.Clerk.openSignUp();
                        }
                    };
                    userButtonDiv.appendChild(signInBtn);
                }
            });
        }

        // Start Clerk initialization
        initClerkAuth();
    </script>

    {% block scripts %}{% endblock %}
</body>

</html>
