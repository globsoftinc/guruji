{% extends "base.html" %}
{% block title %}{{ course.title }} - Guruji{% endblock %}

{% block content %}
<div class="course-detail">
    <div class="course-header">
        <div class="header-content">
            <nav class="breadcrumb"><a href="/courses">Courses</a> <i class="fas fa-chevron-right"></i> <span>{{
                    course.title }}</span></nav>
            <h1>{{ course.title }} <button class="btn btn-sm btn-ghost instructor-only" onclick="openEditCourseModal()"
                    style="display: none; vertical-align: middle;"><i class="fas fa-edit"></i></button></h1>
            <p class="course-subtitle">{{ course.description }}</p>
            <div class="course-info">
                <span><i class="fas fa-user"></i> {{ instructor.name if instructor else 'Instructor' }}</span>
                <span><i class="fas fa-users"></i> {{ student_count }} students</span>
                <span><i class="fas fa-video"></i> {{ (course.completed_classes|length) if course.completed_classes else
                    0 }} lessons</span>
                <span class="certification-badge {{ 'free-cert' if course.price == 0 else 'paid-cert' }}">
                    <i class="fas fa-certificate"></i> {{ 'Free Certification' if course.price == 0 else 'Paid' }}
                </span>
            </div>
            <div id="enroll-section" class="enroll-section">
                <button id="enroll-btn" class="btn btn-primary btn-lg" style="display: none;">
                    <i class="fas fa-user-plus"></i> {{ 'Enroll Free' if course.price == 0 else 'Enroll - Rs. ' +
                    course.price|string }}
                </button>
                <div id="enrolled-badge" class="enrolled-badge" style="display: none;">
                    <i class="fas fa-check-circle"></i> Enrolled
                </div>
                <div id="completed-badge" class="enrolled-badge completed" style="display: none;">
                    <i class="fas fa-trophy"></i> Course Completed
                </div>
                <button id="attendance-btn" class="btn btn-primary btn-lg attendance-btn enrolled-only"
                    style="display: none;">
                    <i class="fas fa-hand-paper"></i> Mark Attendance
                </button>
                <div id="loading-enroll" class="btn btn-ghost btn-lg">
                    <i class="fas fa-spinner fa-spin"></i> Checking...
                </div>
            </div>
        </div>
        <div class="header-visual">
            {% if course.thumbnail %}<img src="{{ course.thumbnail }}">{% else %}<div class="placeholder-visual"><i
                    class="fas fa-play-circle"></i></div>{% endif %}
        </div>
    </div>

    <div class="course-body">
        {% if course.upcoming_classes or course.completed_classes %}
        <div class="content-section">
            <h2><i class="fas fa-calendar"></i> Classes</h2>

            {% if course.upcoming_classes %}
            <h3 style="margin-bottom: 1rem; color: var(--text-secondary); font-size: 0.9rem;"><i
                    class="fas fa-clock"></i> Upcoming</h3>
            <div class="classes-list" id="classes-list">
                {% for class in course.upcoming_classes %}
                <div class="class-card">
                    <div class="class-date">
                        <span class="day">{{ class.datetime.strftime('%d') if class.datetime else '--' }}</span>
                        <span class="month">{{ class.datetime.strftime('%b') if class.datetime else '--' }}</span>
                    </div>
                    <div class="class-details">
                        <h4>{{ class.title }}</h4>
                        <span class="time"><i class="fas fa-clock"></i> {{ class.datetime.strftime('%I:%M %p') if
                            class.datetime else 'TBD' }}</span>
                    </div>
                    <a href="{{ class.meet_link }}" target="_blank" class="btn btn-primary class-action enrolled-only"
                        style="display: none;">
                        <i class="fas fa-video"></i> Join
                    </a>
                    <button class="btn btn-ghost class-action not-enrolled" disabled>
                        <i class="fas fa-lock"></i>
                    </button>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            {% if course.completed_classes %}
            <h3 style="margin: 1.5rem 0 1rem; color: var(--text-secondary); font-size: 0.9rem;"><i
                    class="fas fa-check-circle"></i> Completed</h3>
            <div class="classes-list completed-classes">
                {% for class in course.completed_classes %}
                <div class="class-card" style="opacity: 0.6;">
                    <div class="class-date" style="background: var(--bg-tertiary);">
                        <span class="day">{{ class.datetime.strftime('%d') if class.datetime else '--' }}</span>
                        <span class="month">{{ class.datetime.strftime('%b') if class.datetime else '--' }}</span>
                    </div>
                    <div class="class-details">
                        <h4>{{ class.title }}</h4>
                        <span class="time"><i class="fas fa-clock"></i> {{ class.datetime.strftime('%I:%M %p') if
                            class.datetime else 'TBD' }}</span>
                    </div>
                    <span class="btn btn-ghost" style="cursor: default; opacity: 0.7;">
                        <i class="fas fa-check"></i> Ended
                    </span>
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>
        {% endif %}

        <div class="content-section">
            <h2><i class="fas fa-video"></i> <span>Course Content</span> <button
                    class="btn btn-sm btn-ghost instructor-only h2-btn" onclick="openAddRecordingModal()"
                    style="display: none;"><i class="fas fa-plus"></i></button></h2>
            <div class="recordings-list" id="recordings-list">
                <div class="empty-state small"><i class="fas fa-spinner fa-spin"></i>
                    <p>Loading recordings...</p>
                </div>
            </div>
        </div>

        <!-- Notes Section -->
        <div class="content-section">
            <h2><i class="fas fa-file-pdf"></i> <span>Course Notes</span> <button
                    class="btn btn-sm btn-ghost instructor-only h2-btn" onclick="openAddNoteModal()"
                    style="display: none;"><i class="fas fa-plus"></i></button></h2>
            <div class="notes-list" id="notes-list">
                <div class="empty-state small"><i class="fas fa-spinner fa-spin"></i>
                    <p>Loading notes...</p>
                </div>
            </div>
        </div>

        <!-- Certificate Section -->
        <div class="content-section enrolled-only" id="certificate-section" style="display: none;">
            <h2><i class="fas fa-certificate"></i> Certificate</h2>
            <div id="certificate-content" class="certificate-simple">
                <div class="cert-attendance-info">
                    <div class="cert-stat-row">
                        <div class="cert-stat-item">
                            <i class="fas fa-calendar-check"></i>
                            <span class="cert-stat-label">Classes Attended:</span>
                            <span class="cert-stat-value" id="cert-attendance">--</span>
                        </div>
                        <div class="cert-stat-item">
                            <i class="fas fa-percentage"></i>
                            <span class="cert-stat-label">Attendance:</span>
                            <span class="cert-stat-value" id="cert-percentage">--%</span>
                        </div>
                    </div>
                </div>
                <div id="cert-action" class="cert-action-simple">
                    <!-- Will be populated by JS -->
                </div>
            </div>
        </div>

        {% if instructor %}
        <div class="content-section">
            <h2><i class="fas fa-user"></i> Instructor</h2>
            <div class="instructor-card">
                <div class="instructor-avatar"><i class="fas fa-user"></i></div>
                <div class="instructor-info">
                    <h3>{{ instructor.name }}</h3>
                    <p>{{ instructor.email }}</p>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Edit Course Modal -->
<div id="edit-course-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-edit"></i> Edit Course</h3>
            <button class="modal-close" onclick="closeEditModal()">&times;</button>
        </div>
        <form id="edit-course-form" onsubmit="saveCourse(event)">
            <div class="form-group">
                <label>Title *</label>
                <input type="text" id="edit-title" value="{{ course.title }}" required>
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea id="edit-description" rows="3">{{ course.description }}</textarea>
            </div>
            <div class="form-group">
                <label>Thumbnail URL</label>
                <input type="url" id="edit-thumbnail" value="{{ course.thumbnail or '' }}" placeholder="https://...">
            </div>
            <div class="form-group">
                <label>Price (Rs.)</label>
                <input type="number" id="edit-price" value="{{ course.price }}" min="0">
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-ghost" onclick="closeEditModal()">Cancel</button>
                <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Save Changes</button>
            </div>
        </form>
    </div>
</div>

<!-- Add Note Modal -->
<div id="add-note-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-file-pdf"></i> Add Note</h3>
            <button class="modal-close" onclick="closeAddNoteModal()">&times;</button>
        </div>
        <form id="add-note-form" onsubmit="saveNote(event)">
            <div class="form-group">
                <label>Title *</label>
                <input type="text" id="note-title" placeholder="e.g., Lecture Notes" required>
            </div>
            <div class="form-group">
                <label>Google Drive PDF Link *</label>
                <input type="url" id="note-link" placeholder="https://drive.google.com/file/d/..." required>
                <span class="hint">Paste the shareable link from Google Drive</span>
            </div>
            <div class="form-group">
                <label>Description (Optional)</label>
                <input type="text" id="note-desc" placeholder="e.g., Chapter 1 summary">
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-ghost" onclick="closeAddNoteModal()">Cancel</button>
                <button type="submit" class="btn btn-primary"><i class="fas fa-plus"></i> Add Note</button>
            </div>
        </form>
    </div>
</div>

<!-- Add Recording Modal -->
<div id="add-recording-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-video"></i> Add Recording</h3>
            <button class="modal-close" onclick="closeAddRecordingModal()">&times;</button>
        </div>
        <form id="add-recording-form" onsubmit="saveRecording(event)">
            <div class="form-group">
                <label>Recording Title *</label>
                <input type="text" id="recording-title" placeholder="e.g., Week 1 - Introduction" required>
            </div>
            <div class="form-group">
                <label>Google Drive / Video Link *</label>
                <input type="url" id="recording-link" placeholder="https://drive.google.com/file/d/..." required>
                <span class="hint">Paste the shareable link from Google Drive</span>
            </div>
            <div class="form-group">
                <label>Duration (minutes)</label>
                <input type="number" id="recording-duration" placeholder="e.g., 45" value="0" min="0">
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-ghost" onclick="closeAddRecordingModal()">Cancel</button>
                <button type="submit" class="btn btn-primary"><i class="fas fa-plus"></i> Add Recording</button>
            </div>
        </form>
    </div>
</div>

<!-- PDF Viewer Modal -->
<div id="pdf-modal" class="modal" style="display: none;">
    <div id="pdf-container" class="modal-content"
        style="max-width: 900px; width: 95%; height: 85vh; padding: 0; background: #000;">
        <div id="pdf-header" class="modal-header" style="background: var(--bg-secondary); padding: 1rem;">
            <h3 id="pdf-title" style="margin: 0; color: var(--text-primary);"><i class="fas fa-file-pdf"></i>
                <span>Document</span>
            </h3>
            <div style="display: flex; gap: 0.5rem;">
                <button class="btn btn-sm btn-ghost" onclick="togglePdfFullscreen()" title="Fullscreen">
                    <i class="fas fa-expand" id="pdf-fullscreen-icon"></i>
                </button>
                <button class="modal-close" onclick="closePdfModal()"
                    style="font-size: 1.5rem; background: none; border: none; color: var(--text-primary); cursor: pointer;">&times;</button>
            </div>
        </div>
        <iframe id="pdf-iframe" style="width: 100%; height: calc(100% - 60px); border: none;"
            allow="autoplay; encrypted-media; fullscreen" allowfullscreen>
        </iframe>
    </div>
</div>

<!-- Video Player Modal -->
<div id="video-modal" class="modal" style="display: none;">
    <div id="video-modal-content" class="modal-content"
        style="max-width: 900px; width: 95%; padding: 0; background: #000;">
        <div id="video-header" class="modal-header"
            style="background: var(--bg-secondary); padding: 1rem; transition: opacity 0.3s;">
            <h3 id="video-title" style="margin: 0; color: var(--text-primary);"><i class="fas fa-play-circle"></i>
                <span>Video</span>
            </h3>
            <div style="display: flex; gap: 0.5rem;">
                <button class="btn btn-sm btn-ghost" onclick="toggleVideoFullscreen()" title="Fullscreen">
                    <i class="fas fa-expand" id="video-fullscreen-icon"></i>
                </button>
                <button class="modal-close" onclick="closeVideoModal()"
                    style="font-size: 1.5rem; background: none; border: none; color: var(--text-primary); cursor: pointer;">&times;</button>
            </div>
        </div>
        <div id="video-container" style="position: relative; padding-top: 56.25%; background: #000; cursor: pointer;"
            onclick="toggleVideoHeader()">
            <iframe id="video-iframe"
                style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; pointer-events: auto;"
                allow="autoplay; encrypted-media; fullscreen" allowfullscreen>
            </iframe>
        </div>
    </div>
</div>

<!-- Certificate Name Confirmation Modal -->
<div id="cert-name-modal" class="modal">
    <div class="modal-content" style="max-width: 450px;">
        <div class="modal-header">
            <h3><i class="fas fa-certificate"></i> Confirm Your Name</h3>
            <button class="modal-close" onclick="closeCertNameModal()">&times;</button>
        </div>
        <form id="cert-name-form" onsubmit="confirmCertificateName(event)">
            <div class="form-group">
                <label>Your Name *</label>
                <input type="text" id="cert-student-name" required placeholder="Enter your full name">
                <span class="hint" style="color: #ffc107;">
                    <i class="fas fa-exclamation-triangle"></i>
                    Please enter your name exactly as you want it to appear on your certificate. This cannot be changed
                    later.
                </span>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-ghost" onclick="closeCertNameModal()">Cancel</button>
                <button type="submit" class="btn btn-primary"><i class="fas fa-certificate"></i> Generate
                    Certificate</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const courseId = '{{ course._id }}';
    const instructorClerkId = '{{ instructor.clerk_id if instructor else "" }}';
    let currentPdfUrl = '';
    let currentVideoUrl = '';
    let currentPdfLink = '';
    let currentVideoLink = '';
    let videoHeaderVisible = true;

    function waitForClerk(callback) {
        if (window.Clerk && window.Clerk.load) {
            window.Clerk.load().then(callback).catch(err => console.error('Clerk load error:', err));
        } else {
            setTimeout(() => waitForClerk(callback), 100);
        }
    }

    const isCourseCompleted = {{ 'true' if course.is_completed else 'false' }};

    waitForClerk(async () => {
        const enrollBtn = document.getElementById('enroll-btn');
        const enrolledBadge = document.getElementById('enrolled-badge');
        const completedBadge = document.getElementById('completed-badge');
        const loadingEnroll = document.getElementById('loading-enroll');
        const attendanceBtn = document.getElementById('attendance-btn');

        // Show completed badge if course is completed
        if (isCourseCompleted && completedBadge) {
            completedBadge.style.display = 'inline-flex';
        }

        // Check Instructor status
        if (window.Clerk.user && window.Clerk.user.id === instructorClerkId) {
            document.querySelectorAll('.instructor-only').forEach(el => el.style.display = 'inline-block');
        }

        if (!window.Clerk.user) {
            if (loadingEnroll) loadingEnroll.style.display = 'none';
            if (enrollBtn) {
                // Don't show enroll button if course is completed
                if (isCourseCompleted) {
                    enrollBtn.style.display = 'none';
                } else {
                    enrollBtn.style.display = 'inline-flex';
                }
                enrolledBadge.style.display = 'none';
            }
            // Show lock icons for not-enrolled state
            updateNotEnrolledVisibility();
            // Load notes and recordings (will show lock icons)
            loadNotes();
            loadRecordings();
            return; // Not logged in
        }

        // Check enrollment status
        try {
            const res = await fetch(`/api/enrollment-status/${courseId}`, {
                headers: { 'X-Clerk-User-Id': window.Clerk.user.id }
            });

            const data = await res.json();
            window.enrolledState = data.is_enrolled; // Expose global state

            if (loadingEnroll) loadingEnroll.style.display = 'none';

            if (data.is_enrolled) {
                if (enrolledBadge) enrolledBadge.style.display = 'inline-flex';
                if (enrollBtn) enrollBtn.style.display = 'none';
                updateEnrolledVisibility();

                // Check attendance status and show button if active (only if course not completed)
                if (!isCourseCompleted) {
                    checkAttendanceStatus();
                }

                // Load certificate info
                loadCertificateInfo();
            } else {
                // Don't show enroll button if course is completed
                if (enrollBtn) {
                    if (isCourseCompleted) {
                        enrollBtn.style.display = 'none';
                    } else {
                        enrollBtn.style.display = 'inline-flex';
                    }
                }
                if (enrolledBadge) enrolledBadge.style.display = 'none';
                updateNotEnrolledVisibility();
            }

            // Load notes and recordings after enrollment check is complete
            loadNotes();
            loadRecordings();
        } catch (err) {
            console.error(err);
            if (loadingEnroll) loadingEnroll.style.display = 'none';
            // Default to showing enroll button on error if safe (unless course completed)
            if (enrollBtn && !isCourseCompleted) enrollBtn.style.display = 'inline-flex';
            updateNotEnrolledVisibility();
            loadNotes();
            loadRecordings();
        }
    });

    /* --- Attendance Functions --- */
    async function checkAttendanceStatus() {
        try {
            const res = await fetch(`/api/courses/${courseId}/attendance-status`, {
                headers: { 'X-Clerk-User-Id': window.Clerk.user.id }
            });
            const data = await res.json();

            const attendanceBtn = document.getElementById('attendance-btn');
            if (data.attendance_active && attendanceBtn) {
                attendanceBtn.style.display = 'inline-flex';
            }
        } catch (err) {
            console.error('Error checking attendance:', err);
        }
    }

    document.getElementById('attendance-btn')?.addEventListener('click', async () => {
        if (!window.Clerk.user) return;

        const btn = document.getElementById('attendance-btn');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Marking...';

        try {
            const res = await fetch(`/api/courses/${courseId}/mark-attendance`, {
                method: 'POST',
                headers: { 'X-Clerk-User-Id': window.Clerk.user.id }
            });
            const data = await res.json();

            if (data.success) {
                btn.innerHTML = '<i class="fas fa-check"></i> Attendance Marked!';
                btn.style.background = '#00c853';
                btn.style.borderColor = '#00c853';
            } else {
                btn.innerHTML = '<i class="fas fa-check"></i> ' + data.message;
                btn.style.background = '#666';
                btn.style.borderColor = '#666';
            }
        } catch (err) {
            btn.innerHTML = '<i class="fas fa-times"></i> Error';
            btn.style.background = '#f44336';
        }
    });

    /* --- Certificate Functions --- */
    async function loadCertificateInfo() {
        const certSection = document.getElementById('certificate-section');
        const certAttendance = document.getElementById('cert-attendance');
        const certPercentage = document.getElementById('cert-percentage');
        const certAction = document.getElementById('cert-action');

        // Show certificate section for enrolled students
        certSection.style.display = 'block';

        try {
            // Get attendance info
            const attendanceRes = await fetch(`/api/courses/${courseId}/my-attendance`, {
                headers: { 'X-Clerk-User-Id': window.Clerk.user.id }
            });
            const attendanceData = await attendanceRes.json();

            const attendanceCount = attendanceData.attendance_count || 0;
            const totalClasses = {{ (course.completed_classes | length) if course.completed_classes else 0
        }};
    const percentage = totalClasses > 0 ? Math.round((attendanceCount / totalClasses) * 100) : 0;

    certAttendance.textContent = `${attendanceCount}/${totalClasses}`;
    certPercentage.textContent = `${percentage}%`;

    // Check if certificate already exists
    const certRes = await fetch(`/api/courses/${courseId}/certificate`, {
        headers: { 'X-Clerk-User-Id': window.Clerk.user.id }
    });

    if (certRes.ok) {
        const cert = await certRes.json();
        certAction.innerHTML = `
                    <div class="cert-issued">
                        <i class="fas fa-check-circle"></i> Certificate Issued
                        <span class="cert-code">Code: ${cert.certificate_code}</span>
                    </div>
                    <a href="/verify?code=${cert.certificate_code}" target="_blank" class="btn btn-primary">
                        <i class="fas fa-eye"></i> View Certificate
                    </a>
                `;
    } else if (isCourseCompleted) {
        // Course is completed, check if passed (>= 75% attendance)
        if (percentage >= 75) {
            certAction.innerHTML = `
                        <button onclick="generateCertificate()" class="btn btn-primary btn-lg">
                            <i class="fas fa-certificate"></i> Generate Certificate
                        </button>
                    `;
        } else {
            certAction.innerHTML = `
                        <div class="cert-failed">
                            <i class="fas fa-times-circle"></i> You didn't complete the whole course
                            <p>Minimum 75% attendance required to get certificate.</p>
                        </div>
                    `;
        }
    } else {
        // Course not completed yet
        certAction.innerHTML = `
                    <div class="cert-pending">
                        <i class="fas fa-clock"></i> Certificate will be available after course completion
                    </div>
                `;
    }
        } catch (err) {
        console.error('Error loading certificate info:', err);
    }
    }

    function generateCertificate() {
        // Open modal to confirm name before generating certificate
        const user = window.Clerk.user;
        const userName = user.fullName || `${user.firstName || ''} ${user.lastName || ''}`.trim() || 'User';

        // Pre-fill the name input
        document.getElementById('cert-student-name').value = userName;

        // Show the modal
        document.getElementById('cert-name-modal').classList.add('active');
    }

    function closeCertNameModal() {
        document.getElementById('cert-name-modal').classList.remove('active');
    }

    async function confirmCertificateName(e) {
        e.preventDefault();

        const studentName = document.getElementById('cert-student-name').value.trim();

        if (!studentName) {
            alert('Please enter your name');
            return;
        }

        // Disable submit button to prevent double-click
        const submitBtn = e.target.querySelector('button[type="submit"]');
        const originalBtnText = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';

        try {
            const res = await fetch(`/api/courses/${courseId}/generate-certificate`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Clerk-User-Id': window.Clerk.user.id
                },
                body: JSON.stringify({ student_name: studentName })
            });

            if (res.ok) {
                const cert = await res.json();
                closeCertNameModal();
                alert(`Certificate generated! ðŸŽ‰\nYour certificate code: ${cert.certificate_code}`);
                loadCertificateInfo(); // Reload to show the certificate
            } else {
                const error = await res.json();
                alert('Error: ' + error.error);
            }
        } catch (err) {
            alert('Error generating certificate');
        } finally {
            // Re-enable submit button
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalBtnText;
        }
    }

    function updateEnrolledVisibility() {
        document.querySelectorAll('.enrolled-only').forEach(el => {
            if (el.id !== 'attendance-btn') {
                // Use block for divs that are content sections, inline-flex for others (buttons, badges)
                const isBlockElement = el.tagName === 'DIV' && (el.classList.contains('content-section') || el.id === 'certificate-section');
                el.style.display = isBlockElement ? 'block' : 'inline-flex';
            }
        });
        document.querySelectorAll('.not-enrolled').forEach(el => el.style.display = 'none');
    }
    // Function to show not-enrolled state (lock icons)
    function updateNotEnrolledVisibility() {
        document.querySelectorAll('.enrolled-only').forEach(el => el.style.display = 'none');
        document.querySelectorAll('.not-enrolled').forEach(el => el.style.display = 'inline-flex');
    }

    document.getElementById('enroll-btn')?.addEventListener('click', async () => {
        if (!window.Clerk.user) {
            // Use BrowserDetect for in-app browser compatible auth
            if (window.BrowserDetect) {
                if (window.AuthCache && window.AuthCache.hasAccount()) {
                    window.BrowserDetect.openSignIn();
                } else {
                    window.BrowserDetect.openSignUp();
                }
            } else if (window.AuthCache && window.AuthCache.hasAccount()) {
                window.Clerk.openSignIn();
            } else {
                window.Clerk.openSignUp();
            }
            return;
        }
        const res = await fetch(`/api/enroll/${courseId}`, {
            method: 'POST',
            headers: { 'X-Clerk-User-Id': window.Clerk.user.id }
        });
        if (res.ok) { alert('Enrolled! ðŸŽ‰'); location.reload(); }
        else { alert('Error: ' + (await res.json()).error); }
    });

    /* --- Course Editing Functions --- */
    function openEditCourseModal() {
        document.getElementById('edit-course-modal').classList.add('active');
    }
    function closeEditModal() {
        document.getElementById('edit-course-modal').classList.remove('active');
    }
    async function saveCourse(e) {
        e.preventDefault();
        const title = document.getElementById('edit-title').value;
        const desc = document.getElementById('edit-description').value;
        const thumb = document.getElementById('edit-thumbnail').value;
        const price = document.getElementById('edit-price').value;

        const res = await fetch(`/api/courses/${courseId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json', 'X-Clerk-User-Id': window.Clerk.user.id },
            body: JSON.stringify({ title, description: desc, thumbnail: thumb, price })
        });
        if (res.ok) location.reload();
        else alert('Error updating course');
    }

    /* --- Notes Functions --- */
    async function loadNotes() {
        const notesList = document.getElementById('notes-list');
        if (!window.Clerk.user) {
            notesList.innerHTML = `<div class="empty-state small"><i class="fas fa-lock"></i><p>Sign in to view notes</p></div>`;
            return;
        }

        try {
            const res = await fetch(`/api/courses/${courseId}/notes`, {
                headers: { 'X-Clerk-User-Id': window.Clerk.user.id }
            });

            if (!res.ok) throw new Error('Failed to load notes');

            const notes = (await res.json()).reverse();

            if (notes.length === 0) {
                notesList.innerHTML = `<div class="empty-state small"><i class="fas fa-file-pdf"></i><p>No notes available</p></div>`;
                return;
            }

            const isInstructor = window.Clerk.user.id === instructorClerkId;

            notesList.innerHTML = notes.map(note => `
                <div class="recording-item">
                    <div class="recording-icon"><i class="fas fa-file-pdf"></i></div>
                    <div class="recording-info">
                        <h4>${note.title}</h4>
                        <span class="duration">${note.description || 'PDF Document'}</span>
                    </div>
                    <button onclick="viewPdf('${note.drive_link}', '${note.title.replace(/'/g, "\\'")}')"
                        class="btn btn-sm btn-primary recording-action enrolled-only" style="display: none;">
                        <i class="fas fa-eye"></i> View
                    </button>
                    ${isInstructor ?
                    `<button onclick="deleteNote('${note._id}')" class="btn btn-sm btn-ghost recording-action" style="color: #ff4444; margin-left: 0.5rem;"><i class="fas fa-trash"></i></button>`
                    : `<button class="btn btn-sm btn-ghost recording-action not-enrolled" disabled><i class="fas fa-lock"></i></button>`
                }
                </div>
            `).join('');

            // Apply visibility based on enrollment state
            if (window.enrolledState === true) {
                updateEnrolledVisibility();
            } else {
                updateNotEnrolledVisibility();
            }

        } catch (err) {
            console.error(err);
            notesList.innerHTML = `<div class="empty-state small"><i class="fas fa-file-pdf"></i><p>No notes available</p></div>`;
        }
    }

    function openAddNoteModal() { document.getElementById('add-note-modal').classList.add('active'); }
    function closeAddNoteModal() { document.getElementById('add-note-modal').classList.remove('active'); }

    async function saveNote(e) {
        e.preventDefault();
        const title = document.getElementById('note-title').value;
        const link = document.getElementById('note-link').value;
        const desc = document.getElementById('note-desc').value;

        const res = await fetch(`/api/courses/${courseId}/notes`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-Clerk-User-Id': window.Clerk.user.id },
            body: JSON.stringify({ title, drive_link: link, description: desc })
        });
        if (res.ok) { closeAddNoteModal(); loadNotes(); document.getElementById('add-note-form').reset(); }
        else alert('Error adding note');
    }

    async function deleteNote(noteId) {
        if (!confirm('Are you sure you want to delete this note?')) return;
        const res = await fetch(`/api/courses/${courseId}/notes/${noteId}`, {
            method: 'DELETE',
            headers: { 'X-Clerk-User-Id': window.Clerk.user.id }
        });
        if (res.ok) loadNotes();
        else alert('Error deleting note');
    }

    /* --- Video & PDF Viewer Helper Functions --- */
    function getEmbedUrl(driveLink) {
        let fileId = '';
        if (driveLink.includes('/file/d/')) {
            const match = driveLink.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);
            if (match) fileId = match[1];
        } else if (driveLink.includes('id=')) {
            const match = driveLink.match(/id=([a-zA-Z0-9_-]+)/);
            if (match) fileId = match[1];
        }
        return fileId ? `https://drive.google.com/file/d/${fileId}/preview` : driveLink;
    }

    function playVideo(driveLink, title) {
        const modal = document.getElementById('video-modal');
        const iframe = document.getElementById('video-iframe');
        const titleEl = document.getElementById('video-title').querySelector('span');
        currentVideoLink = driveLink;
        currentVideoUrl = getEmbedUrl(driveLink);
        iframe.src = currentVideoUrl;
        titleEl.textContent = title;
        modal.style.display = 'flex';
        modal.classList.add('active');
        videoHeaderVisible = true;
        document.getElementById('video-header').style.opacity = '1';
    }

    function closeVideoModal() {
        const modal = document.getElementById('video-modal');
        const iframe = document.getElementById('video-iframe');
        iframe.src = '';
        modal.style.display = 'none';
        modal.classList.remove('active');
        currentVideoUrl = '';
        currentVideoLink = '';
        if (document.fullscreenElement) document.exitFullscreen();
    }

    function toggleVideoFullscreen() {
        const container = document.getElementById('video-modal-content');
        const icon = document.getElementById('video-fullscreen-icon');
        if (!document.fullscreenElement) {
            container.requestFullscreen();
            icon.classList.remove('fa-expand');
            icon.classList.add('fa-compress');
        } else {
            document.exitFullscreen();
            icon.classList.remove('fa-compress');
            icon.classList.add('fa-expand');
        }
    }

    function toggleVideoHeader() {
        const header = document.getElementById('video-header');
        videoHeaderVisible = !videoHeaderVisible;
        header.style.opacity = videoHeaderVisible ? '1' : '0';
        header.style.pointerEvents = videoHeaderVisible ? 'auto' : 'none';
    }

    function viewPdf(link, title) {
        const modal = document.getElementById('pdf-modal');
        const iframe = document.getElementById('pdf-iframe');
        const titleEl = document.getElementById('pdf-title').querySelector('span');
        currentPdfLink = link;
        currentPdfUrl = getEmbedUrl(link);
        iframe.src = currentPdfUrl;
        titleEl.textContent = title;
        modal.style.display = 'flex';
        setTimeout(() => modal.classList.add('active'), 10);
    }

    function closePdfModal() {
        const modal = document.getElementById('pdf-modal');
        const iframe = document.getElementById('pdf-iframe');
        iframe.src = '';
        modal.classList.remove('active');
        currentPdfUrl = '';
        currentPdfLink = '';
        setTimeout(() => modal.style.display = 'none', 300);
        if (document.fullscreenElement) document.exitFullscreen();
    }

    function togglePdfFullscreen() {
        const container = document.getElementById('pdf-container');
        const icon = document.getElementById('pdf-fullscreen-icon');
        if (!document.fullscreenElement) {
            container.requestFullscreen();
            icon.classList.remove('fa-expand');
            icon.classList.add('fa-compress');
        } else {
            document.exitFullscreen();
            icon.classList.remove('fa-compress');
            icon.classList.add('fa-expand');
        }
    }

    /* --- Recording Functions --- */
    function openAddRecordingModal() { document.getElementById('add-recording-modal').classList.add('active'); }
    function closeAddRecordingModal() { document.getElementById('add-recording-modal').classList.remove('active'); }

    async function saveRecording(e) {
        e.preventDefault();
        const title = document.getElementById('recording-title').value;
        const link = document.getElementById('recording-link').value;
        const duration = parseInt(document.getElementById('recording-duration').value) || 0;

        const res = await fetch(`/api/courses/${courseId}/recordings`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-Clerk-User-Id': window.Clerk.user.id },
            body: JSON.stringify({ title, drive_link: link, duration })
        });
        if (res.ok) {
            alert('Recording added! ðŸŽ‰');
            closeAddRecordingModal();
            document.getElementById('add-recording-form').reset();
            loadRecordings();
        }
        else alert('Error adding recording');
    }

    async function loadRecordings() {
        const recordingsList = document.getElementById('recordings-list');
        try {
            const res = await fetch(`/api/courses/${courseId}/recordings`, {
                headers: { 'X-Clerk-User-Id': window.Clerk.user?.id || '' }
            });
            const recordings = await res.json();

            if (recordings.length === 0) {
                recordingsList.innerHTML = `<div class="empty-state small"><i class="fas fa-video"></i><p>No recordings yet</p></div>`;
                return;
            }

            const isInstructor = window.Clerk.user?.id === instructorClerkId;

            recordingsList.innerHTML = recordings.map(rec => {
                const durationMins = Math.floor((rec.duration || 0) / 60);
                const durationSecs = String((rec.duration || 0) % 60).padStart(2, '0');
                return `
                <div class="recording-item">
                    <div class="recording-icon"><i class="fas fa-play-circle"></i></div>
                    <div class="recording-info">
                        <h4>${rec.title}</h4>
                        <span class="duration"><i class="fas fa-clock"></i> ${durationMins}:${durationSecs}</span>
                    </div>
                    <button onclick="playVideo('${rec.drive_link}', '${rec.title.replace(/'/g, "\\'")}')" 
                        class="btn btn-sm btn-primary recording-action enrolled-only" style="display: none;">
                        <i class="fas fa-play"></i> Watch
                    </button>
                    ${isInstructor ?
                        `<button onclick="deleteRecording('${rec._id}')" class="btn btn-sm btn-ghost recording-action" style="color: #ff4444; margin-left: 0.5rem;"><i class="fas fa-trash"></i></button>`
                        : `<button class="btn btn-sm btn-ghost recording-action not-enrolled" disabled><i class="fas fa-lock"></i></button>`
                    }
                </div>
            `}).join('');

            // Apply visibility based on enrollment state
            if (window.enrolledState === true) {
                updateEnrolledVisibility();
            } else {
                updateNotEnrolledVisibility();
            }

        } catch (err) {
            console.error(err);
            recordingsList.innerHTML = `<div class="empty-state small"><i class="fas fa-video"></i><p>No recordings yet</p></div>`;
        }
    }

    async function deleteRecording(recordingId) {
        if (!confirm('Are you sure you want to delete this recording?')) return;
        const res = await fetch(`/api/courses/${courseId}/recordings/${recordingId}`, {
            method: 'DELETE',
            headers: { 'X-Clerk-User-Id': window.Clerk.user.id }
        });
        if (res.ok) loadRecordings();
        else alert('Error deleting recording');
    }

    /* --- Event Listeners --- */
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') { closeVideoModal(); closePdfModal(); closeEditModal(); closeAddNoteModal(); closeAddRecordingModal(); closeCertNameModal(); }
    });

    // Handle fullscreen change events
    document.addEventListener('fullscreenchange', () => {
        const videoIcon = document.getElementById('video-fullscreen-icon');
        const pdfIcon = document.getElementById('pdf-fullscreen-icon');
        if (!document.fullscreenElement) {
            // Exited fullscreen
            if (videoIcon) {
                videoIcon.classList.remove('fa-compress');
                videoIcon.classList.add('fa-expand');
            }
            if (pdfIcon) {
                pdfIcon.classList.remove('fa-compress');
                pdfIcon.classList.add('fa-expand');
            }
        }
    });

    document.getElementById('video-modal')?.addEventListener('click', (e) => {
        if (e.target.id === 'video-modal') closeVideoModal();
    });
    document.getElementById('pdf-modal')?.addEventListener('click', (e) => {
        if (e.target.id === 'pdf-modal') closePdfModal();
    });
    document.getElementById('edit-course-modal')?.addEventListener('click', (e) => {
        if (e.target.id === 'edit-course-modal') closeEditModal();
    });
    document.getElementById('add-note-modal')?.addEventListener('click', (e) => {
        if (e.target.id === 'add-note-modal') closeAddNoteModal();
    });
    document.getElementById('add-recording-modal')?.addEventListener('click', (e) => {
        if (e.target.id === 'add-recording-modal') closeAddRecordingModal();
    });
    document.getElementById('cert-name-modal')?.addEventListener('click', (e) => {
        if (e.target.id === 'cert-name-modal') closeCertNameModal();
    });
</script>
{% endblock %}
